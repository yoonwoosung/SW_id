{% extends "layout.html" %}
{% block content %}
<div class="container detail-container">
    <div class="row">
        <div class="col-md-7">
            <!-- ì‚¬ì§„ ìºëŸ¬ì…€ -->
            <div id="experience-carousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    {% if item.images %}
                        {% for image in item.images.split(',') %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/' + image) }}" class="d-block w-100 detail-image" alt="ì²´í—˜ ì‚¬ì§„">
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="carousel-item active">
                           <img src="https://via.placeholder.com/800x400.png?text=Farm+Image" class="d-block w-100 detail-image" alt="ì´ë¯¸ì§€ ì—†ìŒ">
                        </div>
                    {% endif %}
                </div>
                {% if item.images and item.images.split(',')|length > 1 %}
                <a class="carousel-control-prev" href="#experience-carousel" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#experience-carousel" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
                {% endif %}
            </div>

            <!-- ë°©ë¬¸ì í›„ê¸° -->
            <div class="detail-section mt-5">
                <h3>ë°©ë¬¸ì í›„ê¸° ğŸŒŸ</h3>
                {% if session.get('user_id') %}
                <form action="{{ url_for('add_review', item_id=item.id) }}" method="POST" class="mb-4">
                    <div class="form-group">
                        <label for="rating">ë³„ì </label>
                        <select class="form-control" id="rating" name="rating">
                            <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea name="content" class="form-control" rows="3" placeholder="í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mt-2">í›„ê¸° ë“±ë¡</button>
                </form>
                {% else %}
                 <p class="text-muted small">í›„ê¸°ë¥¼ ë‚¨ê¸°ì‹œë ¤ë©´ <a href="{{ url_for('login_page') }}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                {% endif %}
                
                <div class="review-list">
                    {% for review in reviews %}
                    <div class="review-item">
                        <strong>{{ review.user.nickname }}</strong> <span class="text-muted">| {{ review.rating }}ì </span>
                        <p>{{ review.content }}</p>
                        <small class="text-muted">{{ review.timestamp.strftime('%Y-%m-%d') }}</small>
                    </div>
                    {% else %}
                    <p>ì•„ì§ ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- ë¬¸ì˜í•˜ê¸° -->
            <div class="detail-section mt-5">
                <h3>ë¬¸ì˜í•˜ê¸° ğŸ’¬</h3>
                {% if session.get('user_id') %}
                <form action="{{ url_for('add_inquiry', item_id=item.id) }}" method="POST" class="mb-4">
                    <div class="form-group">
                        <textarea name="content" class="form-control" rows="3" placeholder="ë†ì¥ì£¼ì—ê²Œ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ë³´ì„¸ìš”." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mt-2">ë¬¸ì˜ ë“±ë¡</button>
                </form>
                {% else %}
                <p class="text-muted small">ë¬¸ì˜ë¥¼ ë‚¨ê¸°ì‹œë ¤ë©´ <a href="{{ url_for('login_page') }}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                {% endif %}
                
                <div class="review-list">
                    {% for inquiry in inquiries %}
                    <div class="review-item">
                        <strong>{{ inquiry.user.nickname }}</strong>
                        <p>{{ inquiry.content }}</p>
                        <small class="text-muted">{{ inquiry.timestamp.strftime('%Y-%m-%d') }}</small>
                    </div>
                    {% else %}
                    <p>ì•„ì§ ì‘ì„±ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ì •ë³´ -->
        <div class="col-md-5">
            <a href="{{ url_for('experience_apply', item_id=item.id) }}" class="btn btn-success btn-lg btn-block mb-3">ì²´í—˜ ì˜ˆì•½í•˜ê¸°</a>
            
            <div class="detail-info card">
                <div class="card-body">
                    <p><strong>ğŸ“ ìœ„ì¹˜:</strong> {{ item.address_detail }}</p>
                    <p><strong>ğŸŒ¿ ì¹œí™˜ê²½:</strong> {{ "ì˜ˆ" if item.pesticide_free else "ì•„ë‹ˆì˜¤" }}</p>
                    <p><strong>ğŸ’° ë¹„ìš©:</strong> {{ "{:,}".format(item.cost) }}ì› / 1ì¸</p>
                    <p><strong>â³ ëª¨ì§‘ ë§ˆê°:</strong> D-{{ item.d_day }} ({{ item.end_date.strftime('%Y-%m-%d') }})</p>
                    <p><strong>ğŸ‘¥ ëª¨ì§‘ ì¸ì›:</strong> {{ item.current_participants }} / {{ item.max_participants }}ëª…</p>
                    <p><strong>ğŸš— ì£¼ì°¨ ê°€ëŠ¥:</strong> {{ "ì˜ˆ" if item.has_parking else "ì•„ë‹ˆì˜¤" }}</p>
                </div>
            </div>

            <div class="detail-info card mt-4">
                <div class="card-header">ì²´í—˜ ìƒì„¸ì •ë³´</div>
                <div class="card-body">
                    {% if item.notes %}
                    <p><strong>ì±™ê²¨ì˜¤ì„¸ìš”! (ì¤€ë¹„ë¬¼)</strong><br>{{ item.notes }}</p>
                    {% endif %}
                    {% if item.includes %}
                    <p><strong>ì´ëŸ° ê²ƒì„ ì œê³µí•´ìš” (í¬í•¨ ë‚´ì—­)</strong><br>{{ item.includes }}</p>
                    {% endif %}
                    {% if item.excludes %}
                    <p><strong>ì´ê²ƒì€ í¬í•¨ë˜ì§€ ì•Šì•„ìš” (ë¶ˆí¬í•¨ ë‚´ì—­)</strong><br>{{ item.excludes }}</p>
                    {% endif %}
                </div>
            </div>

            {% if item.timetable_data %}
            <div class="detail-info card mt-4">
                <div class="card-header">ìš´ì˜ ì‹œê°„í‘œ</div>
                <div class="card-body">
                    <table class="timetable-display">
                        <thead>
                            <tr><th>ì‹œê°„</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>09:00 - 10:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>10:00 - 11:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>11:00 - 12:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>12:00 - 13:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>13:00 - 14:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>14:00 - 15:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>15:00 - 16:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>16:00 - 17:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <div class="detail-map card mt-4">
                <div class="card-header">ë†ì¥ ìœ„ì¹˜</div>
                <div class="card-body">
                    <div id="map" style="width:100%;height:300px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="item-data-json" style="display: none;">{{ item_data_for_js|tojson|safe }}</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=fa87dcc52c2d82878875da3f4ea6b050"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemDataElement = document.getElementById('item-data-json');
    const itemData = JSON.parse(itemDataElement.textContent);

    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: new kakao.maps.LatLng(itemData.lat, itemData.lng),
        level: 3 // í™•ëŒ€ ë ˆë²¨ ì¡°ì •
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(itemData.lat, itemData.lng)
    });
    marker.setMap(map);

    const timetableData = "{{ item.timetable_data or '' }}";
    if (timetableData) {
        const selectedSlots = timetableData.split(',');
        const dayMap = { 'ì›”': 1, 'í™”': 2, 'ìˆ˜': 3, 'ëª©': 4, 'ê¸ˆ': 5, 'í† ': 6, 'ì¼': 7 };
        const timeMap = {
            '09:00': 1, '10:00': 2, '11:00': 3, '12:00': 4,
            '13:00': 5, '14:00': 6, '15:00': 7, '16:00': 8
        };
        selectedSlots.forEach(slot => {
            const [day, time] = slot.split('-');
            if (day && time && dayMap[day] && timeMap[time]) {
                const colIndex = dayMap[day];
                const rowIndex = timeMap[time];
                const table = document.querySelector('.timetable-display');
                if (table.rows[rowIndex] && table.rows[rowIndex].cells[colIndex]) {
                    const cell = table.rows[rowIndex].cells[colIndex];
                    cell.classList.add('selected');
                }
            }
        });
    }
});
</script>
{% endblock %}