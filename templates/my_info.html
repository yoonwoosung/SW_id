{% extends "layout.html" %}
{% block content %}
<style>
    .cancelled-application {
        background-color: #f8f9fa; /* Light gray background */
        text-decoration: line-through;
        color: #6c757d; /* Muted text color */
    }
    .cancelled-application h5,
    .cancelled-application small {
        color: #6c757d;
    }
</style>
<div class="container my-info-container mt-3">
    <h2 class="mb-4">내 정보</h2>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            회원 정보
            <button id="edit-btn" class="btn btn-outline-primary btn-sm">수정하기</button>
        </div>
        <div class="card-body">
            <form id="info-form" method="POST" action="{{ url_for('my_info') }}">
                <fieldset id="info-fieldset" disabled>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">닉네임</label>
                        <div class="col-sm-9">
                            <input type="text" name="nickname" class="form-control" value="{{ user.nickname }}">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">이름</label>
                        <div class="col-sm-9">
                            <input type="text" name="name" class="form-control" value="{{ user.name }}">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">연락처</label>
                        <div class="col-sm-9">
                            <input type="text" name="phone" class="form-control" value="{{ user.phone }}">
                        </div>
                    </div>
                    {% if user.role == 'farmer' %}
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">농장 주소</label>
                        <div class="col-sm-9">
                            <input type="text" name="farm_address" class="form-control" value="{{ user.farm_address }}">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">농장 규모 (평)</label>
                        <div class="col-sm-9">
                            <input type="text" name="farm_size" class="form-control" value="{{ user.farm_size }}">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">한 줄 소개</label>
                        <div class="col-sm-9">
                            <textarea name="profile_bio" class="form-control" rows="3" placeholder="농장을 방문하는 체험자에게 자신을 알려보세요. 이 소개는 체험 상세 페이지에 표시됩니다.">{{ user.profile_bio or '' }}</textarea>
                        </div>
                    </div>
                    {% endif %}
                </fieldset>
                <div id="form-buttons" class="text-right mt-3" style="display: none;">
                    <button type="button" id="cancel-btn" class="btn btn-secondary">취소</button>
                    <button type="submit" class="btn btn-primary">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <h3 class="mt-5 mb-3">신청한 체험 목록</h3>
    <div class="list-group">
        {% for app in applications %}
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if app.status == '취소' %}cancelled-application{% endif %}">
                <div class="application-detail-trigger flex-grow-1" 
                     data-crop="{{ app.experience.crop }}"
                     data-apply-date="{{ app.apply_date.strftime('%Y-%m-%d') }}"
                     data-apply-time="{{ app.apply_time }}"
                     data-participants="{{ app.participants_count }}"
                     data-status="{{ app.status }}"
                     data-location="{{ app.experience.address_detail }}">
                    <h5 class="mb-1">{{ app.experience.crop }}</h5>
                    <p class="mb-1">
                        <small>
                            신청 날짜: {{ app.apply_date.strftime('%Y-%m-%d') }} {{ app.apply_time }} / 
                            참가 인원: {{ app.participants_count }}명
                        </small>
                    </p>
                </div>
                <div>
                    {% if app.status == '예정' %}
                        <span class="badge badge-primary badge-pill mr-2">{{ app.status }}</span>
                    {% elif app.status == '확정' %}
                        <span class="badge badge-success badge-pill mr-2">{{ app.status }}</span>
                    {% elif app.status == '취소' %}
                        <span class="badge badge-secondary badge-pill mr-2">{{ app.status }}</span>
                    {% else %}
                        <span class="badge badge-light badge-pill mr-2">{{ app.status }}</span>
                    {% endif %}

                    {% if app.status != '취소' %}
                    <form action="{{ url_for('delete_application', app_id=app.id) }}" method="POST" class="d-inline" onsubmit="return confirm('정말로 이 신청을 취소하시겠습니까?');">
                        <button type="submit" class="btn btn-danger btn-sm">취소</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="list-group-item">신청한 체험이 없습니다.</div>
        {% endfor %}
    </div>
</div>

<div id="application-detail-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4>신청 내역 상세</h4>
        <div id="modal-summary" style="margin-top: 1rem;">
            <p><strong>체험명:</strong> <span id="modal-crop"></span></p>
            <p><strong>신청일:</strong> <span id="modal-apply-date"></span></p>
            <p><strong>신청시간:</strong> <span id="modal-apply-time"></span></p>
            <p><strong>참가인원:</strong> <span id="modal-participants"></span>명</p>
            <p><strong>상태:</strong> <span id="modal-status"></span></p>
            <p><strong>장소:</strong> <span id="modal-location"></span></p>
        </div>
        <div class="modal-buttons">
            <button id="modal-close-btn" class="btn btn-success">확인</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('edit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const fieldset = document.getElementById('info-fieldset');
    const formButtons = document.getElementById('form-buttons');

    if (editBtn) {
        editBtn.addEventListener('click', function() {
            fieldset.disabled = false;
            formButtons.style.display = 'block';
            editBtn.style.display = 'none';
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            fieldset.disabled = true;
            formButtons.style.display = 'none';
            editBtn.style.display = 'block';
            location.reload();
        });
    }
    
    const modal = document.getElementById('application-detail-modal');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const applicationTriggers = document.querySelectorAll('.application-detail-trigger');

    const modalCrop = document.getElementById('modal-crop');
    const modalApplyDate = document.getElementById('modal-apply-date');
    const modalApplyTime = document.getElementById('modal-apply-time');
    const modalParticipants = document.getElementById('modal-participants');
    const modalStatus = document.getElementById('modal-status');
    const modalLocation = document.getElementById('modal-location');

    applicationTriggers.forEach(trigger => {
        trigger.addEventListener('click', function() {
            const data = this.dataset;
            
            modalCrop.textContent = data.crop;
            modalApplyDate.textContent = data.applyDate;
            modalApplyTime.textContent = data.applyTime;
            modalParticipants.textContent = data.participants;
            modalStatus.textContent = data.status;
            modalLocation.textContent = data.location;
            
            modal.style.display = 'flex';
        });
    });

    function closeModal() {
        modal.style.display = 'none';
    }

    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}