{% extends "layout.html" %}
{% block content %}
<div class="container dashboard-container">
    <div class="dashboard-grid">
        <aside class="dashboard-sidebar">
            <div class="dashboard-card profile-card">
                <form id="profile-pic-form" method="POST" action="{{ url_for('upload_profile') }}" enctype="multipart/form-data">
                    <label for="profile-pic-input">
                        <img id="profile-pic-preview" src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" alt="Profile Picture" class="profile-pic-img">
                        <div class="profile-pic-overlay">사진 변경</div>
                    </label>
                    <input type="file" id="profile-pic-input" name="profile_pic" accept="image/*" class="d-none">
                </form>
                <h4 class="mt-3">환영합니다,</h4>
                <h3>{{ user.nickname }}님!</h3>
            </div>
            <div class="dashboard-card">
                <h5>내 농장 통계</h5>
                <div class="stats-grid">
                    <span>총 등록 체험</span><span>{{ stats.total_experiences }}</span>
                    <span>평균 별점</span><span>{{ stats.average_rating }} / 5.0</span>
                    <span>총 방문자 수</span><span>{{ stats.total_visitors }}</span>
                </div>
            </div>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-card">
                <h5>내 농장</h5>
                <form id="farm-photo-form" method="POST" action="{{ url_for('upload_farm_photo') }}" enctype="multipart/form-data">
                    <label for="farm-photo-input" class="farm-photo-label">
                        {% if user.farm_image %}
                            <img src="{{ url_for('static', filename='uploads/' + user.farm_image) }}" alt="Farm Photo" class="farm-photo-img">
                            <div class="farm-photo-overlay">
                                <i class="fa-solid fa-camera"></i> 사진 바꾸기
                            </div>
                        {% else %}
                            <div class="farm-photo-placeholder">
                                <i class="fa-solid fa-camera"></i>
                                <span>사진 업로드</span>
                            </div>
                        {% endif %}
                    </label>
                    <input type="file" id="farm-photo-input" name="farm_photo" accept="image/*" class="d-none">
                </form>
            </div>
            <div class="dashboard-card">
                <h5>최근 활동 (내 체험 목록)</h5>
                <ul class="activity-list">
                    {% for item in experiences %}
                    <li class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('experience_detail', item_id=item.id) }}">{{ item.crop }}</a>
                        <div>
                            <a href="{{ url_for('farmer_register', item_id=item.id) }}" class="btn btn-sm btn-outline-primary mr-2">수정</a>
                            <form action="{{ url_for('delete_experience', item_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirmDelete()">
                                <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                            </form>
                        </div>
                    </li>
                    {% else %}
                    <li>등록된 체험이 없습니다.</li>
                    {% endfor %}
                </ul>
                <a href="{{ url_for('farmer_register') }}" class="btn btn-success btn-block mt-3">
                    <i class="fa-solid fa-plus"></i> 새로운 체험 추가하기
                </a>
            </div>
        </main>

        <div class="dashboard-right">
            <div class="dashboard-card">
                <h5>예약 달력</h5>
                <div id="calendar" class="mt-3"></div>
            </div>
            <div class="dashboard-card">
                <h5>최신 문의</h5>
                <ul class="inquiry-list">
                    {% for inquiry in inquiries %}
                    <li>
                        <div>
                            <a href="{{ url_for('experience_detail', item_id=inquiry.experience_id) }}">{{ inquiry.experience.crop }}</a> 체험에 대한 문의
                            <p style="margin: 4px 0 0; font-size: 0.9rem; color: #555;">{{ inquiry.content }}</p>
                        </div>
                        <small class="text-muted">{{ inquiry.timestamp.strftime('%m-%d') }}</small>
                    </li>
                    {% else %}
                    <li>최신 문의가 없습니다.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="reservation-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h4 id="modal-title"></h4>
        <div id="modal-body" class="mt-3">
            </div>
        <div class="modal-buttons">
            <button id="modal-close-btn" class="btn btn-success">확인</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Python에서 전달받은 데이터를 JSON 객체로 안전하게 변환
    const reservationsData = {{ reservations_data | tojson | safe }};
    const experiencesData = {{ experiences | tojson | safe }}; // 체험 기간 정보를 가져옴
    const calendarEl = document.getElementById('calendar');

    // 달력 요소가 페이지에 있을 때만 실행
    if (calendarEl) {
        // 2. 달력에 표시할 '실제 예약' 이벤트 배열 생성 (기존과 동일)
        const calendarEvents = [];
        for (const date in reservationsData) {
            const reservations = reservationsData[date];
            let totalParticipants = 0;
            reservations.forEach(r => {
                totalParticipants += (r.adult + r.teen + r.child);
            });
            
            calendarEvents.push({
                start: date,
                title: `예약 ${reservations.length}건 / 총 ${totalParticipants}명`,
                extendedProps: {
                    reservations: reservations
                }
            });
        }

        // 3. FullCalendar 초기화
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev',
                center: 'title',
                right: 'next today'
            },
            events: calendarEvents, // 실제 예약만 이벤트로 표시
            eventClick: function(info) {
                const modal = document.getElementById('reservation-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                const reservations = info.event.extendedProps.reservations;

                const date = new Date(info.event.startStr + 'T00:00:00');
                modalTitle.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 예약자 정보`;
                
                modalBody.innerHTML = '';
                reservations.forEach(res => {
                    const total = res.adult + res.teen + res.child;
                    const reservationDiv = document.createElement('div');
                    reservationDiv.className = 'reservation-item';
                    reservationDiv.innerHTML = `
                        <div class="reservation-item-header">
                            <strong>${res.name}</strong> (${res.phone})
                            <span>총 ${total}명</span>
                        </div>
                        <small>시간: <strong>${res.time}</strong> | 성인: ${res.adult}명, 청소년: ${res.teen}명, 아동: ${res.child}명</small>
                    `;
                    modalBody.appendChild(reservationDiv);
                });
                
                modal.style.display = 'flex';
            },

            // ▼▼▼ 배경색 및 주말 색상 적용 로직 수정 ▼▼▼
            dayCellDidMount: function(info) {
                const day = info.date.getDay(); // 0:일, 6:토

                // 주말 클래스 추가
                if (day === 0) {
                    info.el.classList.add('sunday-day');
                } else if (day === 6) {
                    info.el.classList.add('saturday-day');
                }

                // 체험 운영 기간인지 확인하여 배경색 클래스 추가
                let isAvailable = false;
                const currentDate = info.date;

                for (const exp of experiencesData) {
                    // new Date()에 'T00:00:00'을 추가하여 UTC 기준으로 날짜를 정확히 파싱
                    const startDate = new Date(exp.duration_start + 'T00:00:00');
                    const endDate = new Date(exp.end_date + 'T00:00:00');

                    if (currentDate >= startDate && currentDate <= endDate) {
                        isAvailable = true;
                        break; // 하나라도 해당되면 더 이상 확인할 필요 없음
                    }
                }

                if (isAvailable) {
                    info.el.classList.add('is-available');
                }
            }
            
        });

        calendar.render();

        // 4. 모달 닫기 기능
        const modal = document.getElementById('reservation-modal');
        const closeModalBtn = document.getElementById('modal-close-btn');
        if(modal && closeModalBtn) {
            closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.style.display = 'none';
            });
        }
    }
});
</script>
{% endblock %}