{% extends "layout.html" %}
{% block content %}
<div class="container detail-container mt-4">

    <div class="row mb-5">
        <div class="col-lg-7">
            <div id="experience-carousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    {% if item.images %}
                        {% for image in item.images.split(',') %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/' + image) }}" class="d-block w-100 detail-image" alt="ì²´í—˜ ì‚¬ì§„">
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="carousel-item active">
                            <div class="image-placeholder">
                                <i class="fa-solid fa-camera"></i>
                                <span>ë†ì¥ì£¼ê°€ ì•„ì§ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% if item.images and item.images.split(',')|length > 1 %}
                <a class="carousel-control-prev" href="#experience-carousel" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                </a>
                <a class="carousel-control-next" href="#experience-carousel" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-5">
            <div class="buy-box-card">
                <h1 class="buy-box-title">{{ item.crop }} ì²´í—˜</h1>
                <div class="buy-box-info">
                    <p><strong>ğŸ“ ìœ„ì¹˜:</strong> {{ item.address_detail }}</p>
                    <p><strong>ğŸŒ¿ ì¹œí™˜ê²½:</strong> {{ "ì˜ˆ" if item.pesticide_free else "ì•„ë‹ˆì˜¤" }}</p>
                    <p><strong>ğŸ‘¥ ëª¨ì§‘ ì¸ì›:</strong> {{ item.current_participants }} / {{ item.max_participants }}ëª…</p>
                    <p><strong>â³ ëª¨ì§‘ ë§ˆê°:</strong> D-{{ item.d_day }} ({{ item.end_date.strftime('%Y-%m-%d') }})</p>
                </div>
                <div class="buy-box-price">
                    <h2 class="font-weight-bold">{{ "{:,}".format(item.cost) }}ì› <small class="text-muted">/ 1ì¸</small></h2>
                </div>
                <a href="{{ url_for('experience_apply', item_id=item.id) }}" class="btn btn-success btn-lg btn-block mt-3">ì²´í—˜ ì˜ˆì•½í•˜ê¸°</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card detail-section-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">ìƒì„¸ ì •ë³´</h3>
                    {% if item.notes %}
                    <p><strong>ì±™ê²¨ì˜¤ì„¸ìš”! (ì¤€ë¹„ë¬¼)</strong><br>{{ item.notes }}</p>
                    {% endif %}
                    {% if item.includes %}
                    <p><strong>ì´ëŸ° ê²ƒì„ ì œê³µí•´ìš” (í¬í•¨ ë‚´ì—­)</strong><br>{{ item.includes }}</p>
                    {% endif %}
                    {% if item.excludes %}
                    <p><strong>ì´ê²ƒì€ í¬í•¨ë˜ì§€ ì•Šì•„ìš” (ë¶ˆí¬í•¨ ë‚´ì—­)</strong><br>{{ item.excludes }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="card detail-section-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">ë†ì¥ ìœ„ì¹˜ ë° ì£¼ë³€ ì‹œì„¤ ğŸ—ºï¸</h3>
                    <div id="map" style="width:100%;height:300px;"></div>
                    <div id="nearby-distances" class="mt-3">
                        <h6 class="mb-2">ì£¼ìš” ì‹œì„¤ê¹Œì§€ì˜ ì§ì„ ê±°ë¦¬</h6>
                        <div id="distance-list">
                            <small class="text-muted">ê°€ì¥ ê°€ê¹Œìš´ ì‹œì„¤ì„ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if item.timetable_data %}
            <div class="card detail-section-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">ìš´ì˜ ì‹œê°„í‘œ ğŸ—“ï¸</h3>
                    <p class="text-muted small mb-2">ë…¹ìƒ‰ ì¹¸ì´ ì‹ ì²­ ê°€ëŠ¥í•œ ì‹œê°„ì…ë‹ˆë‹¤</p>
                    <table class="timetable-display">
                        <thead>
                            <tr><th>ì‹œê°„</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>09:00 - 10:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>10:00 - 11:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>11:00 - 12:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>12:00 - 13:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>13:00 - 14:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>14:00 - 15:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>15:00 - 16:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>16:00 - 17:00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <div class="card detail-section-card mb-4">
                <div class="card-body">
                    <h3 class="card-title">ë†ì¥ì£¼ í”„ë¡œí•„ ğŸ§‘â€ğŸŒ¾</h3>
                     <div class="d-flex align-items-start">
                        <div class="text-center mr-4" style="width: 90px;">
                            <img src="{{ url_for('static', filename='uploads/' + item.farmer.profile_image) }}" alt="{{ item.farmer.nickname }}" class="img-fluid rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover;">
                            <h6 class="mb-0" style="font-weight: bold;">{{ item.farmer.nickname }}</h6>
                        </div>
                        <div class="flex-grow-1" style="padding-top: 10px;">
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 5px;">"{{ item.farmer.profile_bio | default('í•œ ì¤„ ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.', true) }}"</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card detail-section-card">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="reviewInquiryTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="reviews-tab" data-toggle="tab" href="#reviews" role="tab" aria-controls="reviews" aria-selected="true">
                                ë°©ë¬¸ì í›„ê¸° ({{ reviews|length }})
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="inquiries-tab" data-toggle="tab" href="#inquiries" role="tab" aria-controls="inquiries" aria-selected="false">
                                ë¬¸ì˜ì‚¬í•­ ({{ inquiries|length }})
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content" id="reviewInquiryTabContent">
                        <div class="tab-pane fade show active" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                            {% if review_status == 'allowed' %}
                            <form action="{{ url_for('add_review', item_id=item.id) }}" method="POST" class="my-4">
                                <div class="form-group">
                                    <label for="rating">ë³„ì </label>
                                    <select class="form-control" id="rating" name="rating">
                                        <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <textarea name="content" class="form-control" rows="3" placeholder="í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary mt-2">í›„ê¸° ë“±ë¡</button>
                            </form>
                            {% elif review_status == 'already_reviewed' %}
                            <p class="text-muted small my-4">ì´ë¯¸ ì´ ì²´í—˜ì— ëŒ€í•œ í›„ê¸°ë¥¼ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                            {% elif review_status == 'pending_confirmation' %}
                            <p class="text-muted small my-4">ì˜ˆì•½ì´ í™•ì •ëœ í›„ì— í›„ê¸°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            {% elif review_status == 'not_logged_in' %}
                            <p class="text-muted small my-4">í›„ê¸°ë¥¼ ë‚¨ê¸°ì‹œë ¤ë©´ <a href="{{ url_for('login_page') }}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            {% else %}
                            <p class="text-muted small my-4">ì²´í—˜ì„ ì™„ë£Œí•œ ì‚¬ìš©ìë§Œ í›„ê¸°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                            
                            <div class="review-list">
                                {% for review in reviews %}
                                <div class="review-item">
                                    <strong>{{ review.user.nickname }}</strong> <span class="text-muted">| {{ review.rating }}ì </span>
                                    <p>{{ review.content }}</p>
                                    <small class="text-muted">{{ review.timestamp.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% else %}
                                <p class="pt-3">ì•„ì§ ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="tab-pane fade" id="inquiries" role="tabpanel" aria-labelledby="inquiries-tab">
                            {% if session.get('user_id') %}
                            <form action="{{ url_for('add_inquiry', item_id=item.id) }}" method="POST" class="my-4">
                                <div class="form-group">
                                    <textarea name="content" class="form-control" rows="3" placeholder="ë†ì¥ì£¼ì—ê²Œ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ë³´ì„¸ìš”." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary mt-2">ë¬¸ì˜ ë“±ë¡</button>
                            </form>
                            {% else %}
                            <p class="text-muted small my-4">ë¬¸ì˜ë¥¼ ë‚¨ê¸°ì‹œë ¤ë©´ <a href="{{ url_for('login_page') }}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            {% endif %}
                            
                            <div class="review-list">
                                {% for inquiry in inquiries %}
                                <div class="review-item">
                                    <strong>{{ inquiry.user.nickname }}</strong>
                                    <p>{{ inquiry.content }}</p>
                                    <small class="text-muted">{{ inquiry.timestamp.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% else %}
                                <p class="pt-3">ì•„ì§ ì‘ì„±ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             </div>
    </div>
</div>

<div id="item-data-json" style="display: none;">{{ item_data_for_js|tojson|safe }}</div>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=7dd9cd8d1e3754dcf8532c81dea3e95f&libraries=services"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemDataElement = document.getElementById('item-data-json');
        const itemData = JSON.parse(itemDataElement.textContent);

        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(itemData.lat, itemData.lng),
            level: 3
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(itemData.lat, itemData.lng)
        });
        marker.setMap(map);

        const categoriesToSearch = [
            { code: 'CS2', name: 'í¸ì˜ì ', emoji: 'ğŸª' },
            { code: 'PM9', name: 'ì•½êµ­', emoji: 'ğŸ’Š' },
            { code: 'HP8', name: 'ë³‘ì›', emoji: 'ğŸ¥' },
            { code: 'PK6', name: 'ê³µìš©ì£¼ì°¨ì¥', emoji: 'ğŸ…¿ï¸' }
        ];

        const ps = new kakao.maps.services.Places();
        const listContainer = document.getElementById('distance-list');
        const farmLatLng = new kakao.maps.LatLng(itemData.lat, itemData.lng);
        listContainer.innerHTML = '';

        categoriesToSearch.forEach(category => {
            const searchOptions = {
                location: farmLatLng,
                radius: 20000,
                size: 1,
                sort: kakao.maps.services.SortBy.DISTANCE
            };

            const callback = function(result, status) {
                const p = document.createElement('p');
                p.className = 'mb-1';

                if (status === kakao.maps.services.Status.OK) {
                    if (result.length > 0) {
                        const place = result[0];
                        const placeLatLng = new kakao.maps.LatLng(place.y, place.x);
                        const polyline = new kakao.maps.Polyline({ path: [farmLatLng, placeLatLng] });
                        const distance = Math.round(polyline.getLength());
                        let distanceText = (distance > 1000) ? `ì•½ ${(distance / 1000).toFixed(1)} km` : `ì•½ ${distance} m`;
                        p.innerHTML = `${category.emoji} ${category.name}: <strong>${distanceText}</strong> <small class="text-muted">(${place.place_name})</small>`;
                    } else {
                        p.innerHTML = `${category.emoji} ${category.name}: <span class="text-muted">ì£¼ë³€ì— ì—†ìŒ</span>`;
                    }
                } else {
                    p.innerHTML = `${category.emoji} ${category.name}: <span class="text-danger">ê²€ìƒ‰ ì‹¤íŒ¨</span>`;
                }
                listContainer.appendChild(p);
            };

            ps.categorySearch(category.code, callback, searchOptions);
        });

        const timetableData = "{{ item.timetable_data or '' }}";
        if (timetableData) {
            const selectedSlots = timetableData.split(',');
            const dayMap = { 'ì›”': 1, 'í™”': 2, 'ìˆ˜': 3, 'ëª©': 4, 'ê¸ˆ': 5, 'í† ': 6, 'ì¼': 7 };
            const timeMap = {
                '09:00': 1, '10:00': 2, '11:00': 3, '12:00': 4,
                '13:00': 5, '14:00': 6, '15:00': 7, '16:00': 8
            };
            selectedSlots.forEach(slot => {
                const [day, time] = slot.split('-');
                if (day && time && dayMap[day] && timeMap[time]) {
                    const colIndex = dayMap[day];
                    const rowIndex = timeMap[time];
                    const table = document.querySelector('.timetable-display');
                    if (table.rows[rowIndex] && table.rows[rowIndex].cells[colIndex]) {
                        const cell = table.rows[rowIndex].cells[colIndex];
                        cell.classList.add('selected');
                    }
                }
            });
        }
    });
</script>
{% endblock %}