{% extends "layout.html" %}
{% block content %}
<div class="container apply-container">
    <div class="apply-form-v2">
        <div class="text-center">
            <h2>{{ item.crop }} ì²´í—˜ ì‹ ì²­</h2>
            <p class="text-muted">ğŸ“ ì¥ì†Œ: {{ item.address_detail }}</p>
            <p class="text-muted small">ğŸš— ì£¼ì°¨ ê°€ëŠ¥ ì—¬ë¶€: <strong style="color: #333;">{{ "ê°€ëŠ¥" if item.has_parking else "ë¶ˆê°€" }}</strong></p>
        </div>

        <form method="POST" id="apply-form" action="{{ url_for('experience_apply', item_id=item.id) }}">
            <div class="form-group">
                <label>ì‹ ì²­ì ì´ë¦„</label>
                <input type="text" id="applicant_name" name="applicant_name" class="form-control" placeholder="í™ê¸¸ë™" required>
            </div>
             <div class="form-group">
                <label>ì—°ë½ì²˜</label>
                <input type="tel" id="phone_number" name="phone_number" class="form-control" placeholder="010-1111-1111" required>
            </div>
             <div class="form-group">
                <label>ì°¸ê°€ì ì—°ë ¹ëŒ€</label>
                <div class="d-flex">
                    <div class="input-group mr-2">
                        <div class="input-group-prepend"><span class="input-group-text">ì„±ì¸</span></div>
                        <input type="number" id="count_adult" name="count_adult" class="form-control" value="1" min="0">
                    </div>
                    <div class="input-group mr-2">
                        <div class="input-group-prepend"><span class="input-group-text">ì²­ì†Œë…„</span></div>
                        <input type="number" id="count_teen" name="count_teen" class="form-control" value="0" min="0">
                    </div>
                    <div class="input-group">
                        <div class="input-group-prepend"><span class="input-group-text">ì•„ë™</span></div>
                        <input type="number" id="count_child" name="count_child" class="form-control" value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>í¬ë§ ì²´í—˜ ë‚ ì§œ</label>
                <input type="date" id="apply_date" name="apply_date" class="form-control"
                       min="{{ item.duration_start.strftime('%Y-%m-%d') }}"
                       max="{{ item.end_date.strftime('%Y-%m-%d') }}" required>
            </div>

            <div class="form-group">
                <label>í¬ë§ ì²´í—˜ ì‹œê°„</label>
                <p class="text-muted small" id="time-select-guide">ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                <table class="timetable-apply" style="display: none;">
                    <thead>
                        <tr><th>ì‹œê°„</th><th>ì„ íƒ</th></tr>
                    </thead>
                    <tbody>
                        <tr><td data-time="09:00">09:00 - 10:00</td><td class="time-slot" data-time="09:00"></td></tr>
                        <tr><td data-time="10:00">10:00 - 11:00</td><td class="time-slot" data-time="10:00"></td></tr>
                        <tr><td data-time="11:00">11:00 - 12:00</td><td class="time-slot" data-time="11:00"></td></tr>
                        <tr><td data-time="12:00">12:00 - 13:00</td><td class="time-slot" data-time="12:00"></td></tr>
                        <tr><td data-time="13:00">13:00 - 14:00</td><td class="time-slot" data-time="13:00"></td></tr>
                        <tr><td data-time="14:00">14:00 - 15:00</td><td class="time-slot" data-time="14:00"></td></tr>
                        <tr><td data-time="15:00">15:00 - 16:00</td><td class="time-slot" data-time="15:00"></td></tr>
                        <tr><td data-time="16:00">16:00 - 17:00</td><td class="time-slot" data-time="16:00"></td></tr>
                    </tbody>
                </table>
                <input type="hidden" id="selected-time" name="apply_time" required>
            </div>

            <input type="hidden" id="participants_count" name="participants_count" value="1">

            <div class="text-center">
                <button type="submit" class="btn btn-success btn-lg">ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const dateInput = document.getElementById('apply_date');
    const timeTable = document.querySelector('.timetable-apply');
    const timeSelectGuide = document.getElementById('time-select-guide');
    const timeSlots = document.querySelectorAll('.timetable-apply .time-slot');
    const hiddenTimeInput = document.getElementById('selected-time');

    const applyForm = document.getElementById('apply-form');
    if (applyForm) {
        applyForm.addEventListener('submit', function(event) {
            const selectedDate = document.getElementById('apply_date').value;
            const selectedTime = document.getElementById('selected-time').value;

            // ë‚ ì§œë‚˜ ì‹œê°„ì´ ë¹„ì–´ìˆìœ¼ë©´
            if (!selectedDate || !selectedTime) {
                // ê²½ê³ ì°½ì„ ë„ìš°ê³ 
                alert('ì²´í—˜ì„ ì‹ ì²­í•˜ë ¤ë©´ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
                // í¼ ì œì¶œì„ ë§‰ìŠµë‹ˆë‹¤.
                event.preventDefault(); 
            }
        });
    }

    // 2. ë†ì¥ì£¼ê°€ ì„¤ì •í•œ ì „ì²´ ìš´ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ê°ì²´ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    // ì˜ˆ: { 'ì›”': ['09:00', '10:00'], 'í™”': ['14:00'] }
    const availableSlotsData = "{{ item.timetable_data or '' }}";
    const availableSlotsByDay = {};
    availableSlotsData.split(',').forEach(slot => {
        const [day, time] = slot.split('-');
        if (day && time) {
            if (!availableSlotsByDay[day]) {
                availableSlotsByDay[day] = [];
            }
            availableSlotsByDay[day].push(time);
        }
    });

    // 3. ë‚ ì§œ ì…ë ¥ì°½ì˜ ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë  í•¨ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        if (!this.value) { // ë‚ ì§œ ì„ íƒì´ ì·¨ì†Œëœ ê²½ìš°
            timeTable.style.display = 'none';
            timeSelectGuide.textContent = 'ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.';
            hiddenTimeInput.value = ''; // ì„ íƒê°’ ì´ˆê¸°í™”
            return;
        }

        // ì„ íƒëœ ë‚ ì§œì˜ ìš”ì¼ì„ êµ¬í•©ë‹ˆë‹¤. (ì¼=0, ì›”=1, ..., í† =6)
        const dayIndex = selectedDate.getDay();
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const selectedDay = days[dayIndex];

        // í•´ë‹¹ ìš”ì¼ì— ìš´ì˜í•˜ëŠ” ì‹œê°„ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const availableTimes = new Set(availableSlotsByDay[selectedDay] || []);

        // ì‹œê°„í‘œë¥¼ í™”ë©´ì— ë³´ì—¬ì£¼ê³  ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
        timeTable.style.display = 'table';
        timeSelectGuide.textContent = `ì„ íƒí•˜ì‹  ë‚ ì§œ(${selectedDay}ìš”ì¼)ì— ê°€ëŠ¥í•œ ì‹œê°„ì…ë‹ˆë‹¤.`;
        hiddenTimeInput.value = ''; // ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”

        // ëª¨ë“  ì‹œê°„ ìŠ¬ë¡¯ì„ ìˆœíšŒí•˜ë©° ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        timeSlots.forEach(slot => {
            // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            slot.replaceWith(slot.cloneNode(true));
        });
        
        // ìƒˆë¡œ ë³µì œëœ ìŠ¬ë¡¯ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ì„¤ì •
        document.querySelectorAll('.timetable-apply .time-slot').forEach(slot => {
            const time = slot.dataset.time;

            // ëª¨ë“  í´ë˜ìŠ¤ ì´ˆê¸°í™”
            slot.className = 'time-slot';
            
            if (availableTimes.has(time)) {
                slot.classList.add('available');
                slot.textContent = 'ì„ íƒ';
                slot.addEventListener('click', function() {
                    const currentSelected = document.querySelector('.timetable-apply .time-slot.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                        currentSelected.textContent = 'ì„ íƒ';
                    }
                    slot.classList.add('selected');
                    slot.textContent = 'âœ“';
                    hiddenTimeInput.value = time;
                });
            } else {
                slot.classList.add('unavailable');
                slot.textContent = 'X';
            }
        });
    });
});
</script>
{% endblock %}